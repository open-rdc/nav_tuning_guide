# AMCLのパラメータ調整方法_1

最初に調整するべきパラメータは`odom_alpha1`~`odom_alpha4`で, これらがデフォルト値のままでは自己位置推定が安定しにくいです.      
ここでは端的にそれらのパラメータの意味を説明し, その調整方法を述べます.  

---

## パラメータの説明([参考](http://wiki.ros.org/amcl#Parameters))
これらのパラメータは, **オドメトリの信頼度**に関わります.  
値を大きくすると「ノイズが大きい」と判断してオドメトリを信用しなくなり, 値を小さくするとオドメトリを信用するようになります.  

屋外ではオドメトリ誤差が大きくなるため, 小さくしすぎると誤推定に繋がるので注意してください.  
💡 `odom_alpha2`と`odom_alpha3`の調整が効果的です.  

### `odom_alpha1`
- **意味**: ロボットの動きの回転成分から予想される回転推定におけるノイズ *(default: 0.2)*
- ロボットが**その場で回転しているとき**に, パーティクルの回転方向への広がりに影響します
- 🚫 注意: 「カーブ走行」（= 並進＋回転）ではこのパラメータの効果はほとんど発揮されません
- 💡 回転時にパーティクルがどう広がるかを確認したい方は, [こちらの動画](https://youtu.be/rg_rXQvE8Ao)が参考になります

### `odom_alpha2`
- **意味**: ロボットの動きの並進成分から予想される回転推定におけるノイズ *(default: 0.2)*  
- 並進時, 下の図のようにパーティクルを膨張/収縮させるためのパラメータです  
![](images/abc_3.png)  

### `odom_alpha3`
- **意味**: ロボットの動きの並進成分から予想される並進推定におけるノイズ *(default: 0.2)*
- 並進時, 下の図のようにパーティクルを膨張/収縮させるためのパラメータです  
![](images/alpha3_big2.png)  

### `odom_alpha4`
- **意味**: ロボットの動きの回転成分から予想される並進推定におけるノイズ *(default: 0.2)*  
- こちらも`odom_alpha1`と同様に, **その場回転時**に自己位置パーティクルの広がりに影響します
- 🚫 自律走行のように**並進主体の動き**が多いシナリオでは, `odom_alpha4`はあまり効果を発揮しません
- ✅ 回転動作が多い環境では, 調整によって効果が現れるケースもあります
---

## 調整方法

### 1. rosbagで走行/センサデータを記録
まず, `rosbag`を記録します. navigation時とコントローラ操作時の両方を記録することが望ましいです. このとき, 上記パラメータはデフォルト値, もしくはそれ以下の値に設定してください. 

```bash
$ rosbag record -a
```
上記だとrosbagのファイルサイズが**数十GB**を超えるので, 必要最低限のトピックは[こちら](https://github.com/YuseiShiozawa/orne-box/blob/box2/orne_box_bringup/launch/includes/rosbag_shiozawa.launch)にまとめました. 必要に応じてトピックを追加/削除してください.  

自己位置が破綻したら, `Ctrl+C`で記録を終了します.  

---

### 2. Rvizでパーティクル挙動を可視化
Rvizを使用して, パーティクルの散らばりや自己位置のずれ方を確認します. これにより, どのパラメータに問題があるかをある程度予想します.  

#### コマンド例:
##### 過去のデータを再生して確認
- 過去の走行データをそのまま確認します
- 再生するrosbagファイルはnavigation時のもの
```bash
# 端末1
$ roscore

# 端末2
$ cd ~/catkin_ws/src/orne-box/orne_box_navigation_executor/rviz_cfg
$ rviz -d nav.rviz

# 端末3
$ rosbag play rosbagファイル名
```

##### オフラインで自己位置推定を行って確認
- 上記の方法とは異なり, **パラメータを実際に変更しながら**パーティクルの変化を確認することができます 
- 再生するrosbagファイルはコントローラ操作時のもの
  - navigation時のrosbagファイルでもできないことはないのですが, `tf`が重複しRviz画面が見づらいです
- 下記の[only_localization.launch](https://github.com/YuseiShiozawa/orne-box/blob/test4/orne_box_navigation_executor/launch/only_localization.launch)を使えば, AMCLとRvizを同時に起動できます
  - AMCLとRvizが立ち上がればなんでもいいです
```bash
# 端末1
$ roslaunch orne_box_navigation_executor only_localization.launch 

# 端末2
$ rosbag play rosbagファイル名 --topics /tf /tf_static /scan
```


---

### 3. 問題の特定とパラメータ調整
#### a. 並進方向のずれ → `odom_alpha3`
以下の図のように, スキャンデータ(紫)と地図(黒)が並進方向にずれている場合: 
- `odom_alpha3`を**0.05～0.1ずつ増加**させて調整  
- おそらくこのような並進方向のずれが発生する場合は, 他の箇所でも複数似たようなことが起きると思います
- 値を徐々に大きくし, 並進方向のずれが発生する箇所が減ることを確認してください  
  - 発生する箇所を0にするのはかなり難しいと思います(多少のズレなら補正できるので下図のように極端にずれていなければok)
  - 大きくしすぎると自己位置推定が破綻するので注意してください   
![](images/tatezure.png)  

#### b. 回転(横)方向のずれ → `odom_alpha2`
以下の図のように, スキャンデータ(紫)と地図(黒)が回転方向にずれている場合: 
- `odom_alpha2`を**0.05～0.1ずつ増加**させて調整
- おそらくこのような回転方向のずれが発生する場合は, 他の箇所でも複数似たようなことが起きると思います
- 値を徐々に大きくし, 回転方向のずれが発生する箇所が減ることを確認してください  
  - 発生する箇所を0にするのはかなり難しいと思います(多少のズレなら補正できるので下図のように極端にずれていなければok)
  - 大きくしすぎると自己位置推定が破綻するので注意してください  
![](images/yokozure.png)  

#### c. 自己位置が徐々にずれていく → `odom_alpha1`~`odom_alpha4`
以下の図のように, 自己位置が徐々にずれていく場合: 
- `odom_alpha1`~`odom_alpha4`(特にalpha2, 3)を**0.05~0.1ずつ減少**
  - パーティクルが広がり, 推定される自己位置の範囲を制限するため   
---
![かなり極端な例](images/jump.gif) 

---

### 4. 調整の終わり
調整はコントローラ操作時のrosbagで, 上記の問題がなく, 最終ゴールまで自己位置推定がずれていなければ終えてください.  
調整完了後は, 実ロボットを使って自律走行を行いましょう.  
調整後パラメータで以下を確認してください：

✅ コントローラ操作時のrosbagで自己位置破綻がない  
✅ 自律走行でゴールまで破綻なく移動できる

※このときもrosbagを記録しておくと再調整時に便利です.  

---

### 補足: 地図とオドメトリ, どちらを信頼するか？
地図が高精度で実環境と一致している場合は, スキャンマッチング（AMCLのコア）が有効に働くため, `odom_alpha`を多少大きくしても自己位置推定は安定します.  
一方で, 地図の精度が低かったり, 実環境の変化が起こりやすい場合は, スキャンマッチングが不正確になるため, `odom_alpha`を小さくしてオドメトリに頼る方が安定するケースがあります.  

⚠️ ただし, オドメトリに過度に依存すると, 特に屋外では誤差が累積しやすくなり, 自己位置破綻のリスクが上がります.  

👉 こうしたトレードオフの見極めが, パラメータ調整の難しいところだと考えています.  

---
その他パラメータの調整↓
- [amcl_2.md](./amcl_2.md)